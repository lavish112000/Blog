name: Code Review Automation

on:
  pull_request:
    types: [opened, synchronize, reopened]
  pull_request_review:
    types: [submitted]

jobs:
  auto-label:
    name: Auto Label PR
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Label based on files changed
        uses: actions/labeler@v5
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}

  size-label:
    name: Label PR Size
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Calculate PR size
        id: size
        run: |
          # Get changed lines
          git fetch origin ${{ github.base_ref }}
          LINES=$(git diff --stat origin/${{ github.base_ref }}...HEAD | tail -1 | awk '{print $4}' | sed 's/[^0-9]//g')
          echo "lines=$LINES" >> $GITHUB_OUTPUT
          
          # Determine size label
          if [ "$LINES" -lt 50 ]; then
            echo "label=size/XS" >> $GITHUB_OUTPUT
          elif [ "$LINES" -lt 200 ]; then
            echo "label=size/S" >> $GITHUB_OUTPUT
          elif [ "$LINES" -lt 500 ]; then
            echo "label=size/M" >> $GITHUB_OUTPUT
          elif [ "$LINES" -lt 1000 ]; then
            echo "label=size/L" >> $GITHUB_OUTPUT
          else
            echo "label=size/XL" >> $GITHUB_OUTPUT
          fi

      - name: Add size label
        uses: actions/github-script@v7
        with:
          script: |
            const label = '${{ steps.size.outputs.label }}';
            const { owner, repo, number } = context.issue;
            
            // Remove old size labels
            const allLabels = await github.rest.issues.listLabelsOnIssue({ owner, repo, issue_number: number });
            const sizeLabels = allLabels.data.filter(l => l.name.startsWith('size/'));
            for (const sizeLabel of sizeLabels) {
              await github.rest.issues.removeLabel({ owner, repo, issue_number: number, name: sizeLabel.name });
            }
            
            // Add new size label
            await github.rest.issues.addLabels({ owner, repo, issue_number: number, labels: [label] });

  checklist-validator:
    name: Validate PR Checklist
    runs-on: ubuntu-latest
    permissions:
      pull-requests: read
      issues: write
    
    steps:
      - name: Check PR description
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            
            const body = pr.body || '';
            const requiredSections = [
              '## Description',
              '## Type of Change',
              '## Testing Performed',
              '## 10-Point Code Review Checklist'
            ];
            
            const missingSections = requiredSections.filter(section => !body.includes(section));
            
            if (missingSections.length > 0) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `âš ï¸ **PR Template Incomplete**\n\nPlease complete the following sections in your PR description:\n${missingSections.map(s => `- ${s}`).join('\n')}\n\nRefer to the [PR template](.github/pull_request_template.md) for guidance.`
              });
            }

  welcome-first-time:
    name: Welcome First-Time Contributors
    runs-on: ubuntu-latest
    if: github.event.action == 'opened'
    permissions:
      pull-requests: read
      issues: write
    
    steps:
      - name: Check if first-time contributor
        uses: actions/github-script@v7
        with:
          script: |
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'all',
              creator: context.payload.pull_request.user.login
            });
            
            // If this is their first PR
            if (prs.length === 1) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `ğŸ‘‹ Welcome @${context.payload.pull_request.user.login}!\n\nThank you for your first contribution to the project! ğŸ‰\n\nPlease make sure to:\n- Review our [Contributing Guidelines](CONTRIBUTING.md)\n- Complete the PR checklist\n- Respond to any review feedback\n\nA maintainer will review your PR soon. Feel free to ask questions if you need help!`
              });
              
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: ['first-time-contributor']
              });
            }

  code-review-reminder:
    name: Review Reminder
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && github.event.action == 'synchronize'
    permissions:
      pull-requests: read
      issues: write
    
    steps:
      - name: Check review status
        uses: actions/github-script@v7
        with:
          script: |
            const { data: reviews } = await github.rest.pulls.listReviews({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            
            const hasApproval = reviews.some(r => r.state === 'APPROVED');
            
            if (!hasApproval) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `ğŸ”„ **New changes pushed**\n\nThis PR has been updated with new commits. Please review the changes using the [10-Point Code Review Checklist](CODE_REVIEW_CHECKLIST.md).\n\n**Review Focus Areas:**\n- Code quality and standards\n- Testing coverage\n- Security considerations\n- Performance impact`
              });
            }

  thank-reviewer:
    name: Thank Reviewers
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request_review' && github.event.review.state == 'approved'
    permissions:
      issues: write
    
    steps:
      - name: Thank reviewer
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `âœ… Thank you @${context.payload.review.user.login} for reviewing this PR! ğŸ™`
            });
